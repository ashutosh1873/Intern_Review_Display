<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intern Reviews Display</title>
<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 0;
    text-align: center;
  }

  h2 {
    margin: 30px 0 20px;
    color: #333;
    font-weight: 600;
  }

  .review-container {
    position: relative;
    max-width: 750px;
    margin: 25px auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    padding: 30px;
    transition: opacity 0.8s ease-in-out;
  }

  .stars {
    color: #ffb400;
    font-size: 24px;
    margin-bottom: 12px;
  }

  .text {
    font-style: italic;
    font-size: 16px;
    margin-bottom: 12px;
    line-height: 1.5;
  }

  .meta {
    font-size: 0.95em;
    color: #555;
  }

  .controls {
    margin-top: 15px;
  }

  .btn {
    display: inline-block;
    margin: 5px;
    padding: 9px 18px;
    border-radius: 8px;
    border: none;
    background: #0078D7;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
  }

  .btn:hover { background: #005fa3; }

  .fade { opacity: 0; }
</style>
</head>
<body>

<h2>Intern Reviews</h2>

<div id="reviewContainer" class="review-container">
  <p>Loading reviews...</p>
</div>

<div class="controls">
  <button class="btn" id="prevBtn">⟨ Prev</button>
  <button class="btn" id="nextBtn">Next ⟩</button>
</div>

<script>
  // ==============================
  // Replace with your deployed Apps Script Web App URL
  const endpoint = "https://script.google.com/macros/s/AKfycbysqa2MJ7ZEEBXhK-bRZaSWFegmOnx_X187zV9eOVncifwMSRua8VLXBZPjtxMxqU8vtA/exec";
  // ==============================

  let reviews = [];
  let idx = 0;
  const displayTime = 7000; // 7 seconds per review
  const container = document.getElementById('reviewContainer');
  let autoSlideTimer = null;

  async function fetchReviews() {
    try {
      const res = await fetch(endpoint + "?action=list", { cache: 'no-store' });
      const data = await res.json();

      if (!data || data.length === 0) {
        container.innerHTML = "<p>No reviews yet.</p>";
        return;
      }

      // Reverse order so newest is first
      reviews = data.reverse();
      idx = 0;
      showReview();

      // Clear any previous timer before setting a new one
      if (autoSlideTimer) clearInterval(autoSlideTimer);

      // Auto-slide for each review, then refetch after full cycle
      autoSlideTimer = setInterval(() => {
        idx = (idx + 1) % reviews.length;
        showReview();
        // If we've just shown the last review, refetch new data next cycle
        if (idx === reviews.length - 1) {
          setTimeout(fetchReviews, displayTime);
        }
      }, displayTime);

    } catch (err) {
      console.error("Error fetching reviews:", err);
      container.innerHTML = "<p>Error loading reviews.</p>";
    }
  }

  function starsHTML(n) {
    n = parseInt(n) || 0;
    let str = "";
    for (let i = 1; i <= 5; i++) str += (i <= n) ? '★' : '☆';
    return str;
  }

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }

  function showReview() {
    if (reviews.length === 0) return;
    const r = reviews[idx];
    const date = r.timestamp ? new Date(r.timestamp).toLocaleDateString() : '';
    const name = r.anonymous ? "Anonymous Intern" : (r.name || "Unnamed");
    const batch = r.anonymous ? "" : (r.batch ? ` (${r.batch})` : "");

    container.classList.add("fade");
    setTimeout(() => {
      container.innerHTML = `
        <div class="stars">${starsHTML(r.rating)}</div>
        <div class="text">"${escapeHtml(r.review)}"</div>
        <div class="meta">— ${escapeHtml(name)}${escapeHtml(batch)}, ${date}</div>
      `;
      container.classList.remove("fade");
    }, 400);
  }

  // Prev/Next Buttons
  document.getElementById('prevBtn').onclick = () => {
    if (reviews.length === 0) return;
    idx = (idx - 1 + reviews.length) % reviews.length;
    showReview();
  };

  document.getElementById('nextBtn').onclick = () => {
    if (reviews.length === 0) return;
    idx = (idx + 1) % reviews.length;
    showReview();
  };

  fetchReviews();
</script>

</body>
</html>
